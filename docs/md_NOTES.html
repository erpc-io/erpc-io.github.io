<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: Code notes</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Code notes </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li>The packet number carried in packet headers may not match the packet's index in MsgBuffers.</li>
<li>The Rpc object cannot be destroyed by a background thread or while the foreground thread is in the event loop (i.e., by the request handler or continuation user code). This means that an initially valid Rpc object will stay valid for an interation of the event loop.</li>
</ul>
<h2>MsgBuffer ownership notes</h2>
<ul>
<li>The correctness of this reasoning depends on restrictions on the request handler and continuation functions. These functions can only enqueue requests and responses, but cannot invoke the event loop. The event loop can modify RX ring memory, which is unsafe if a fake buffer's ownership has been passed to the application.</li>
<li>The two interesting cases first:<ul>
<li>Request MsgBuffer ownership at server: The request handler loses ownership of the request MsgBuffer when it returns, or when it calls <code>enqueue_response()</code>, whichever is first.<ul>
<li>When <code>enqueue_response()</code> is called, we allow the client to send us a new request. So we cannot wait until the request handler returns to bury the request MsgBuffer. If we do so, we can bury a newer request's MsgBuffer when a background request handler returns.</li>
<li>The app loses ownership of the request MsgBuffer when the request handler returns, even though eRPC may delay burying it until <code>enqueue_response()</code> is called. This constraint is required because we execute foreground handlers for short requests off the RX ring.</li>
<li>Request handle ownership is released on <code>enqueue_response()</code>, which may happen after the request handler returns.</li>
</ul>
</li>
<li>Response MsgBuffer ownership at client: The response MsgBuffer is owned by the user.</li>
</ul>
</li>
<li>The two less interesting cases:<ul>
<li>Request MsgBuffer ownership at client: Request MsgBuffers are owned and allocated by apps and are never freed by eRPC. The client temporarily loses ownership of the request MsgBuffer until the continuation for the request is invoked, at which point it is no longer needed for retransmission.</li>
<li>Response MsgBuffer ownership at server: The request handler loses ownership of the response MsgBuffer when it calls <code>enqueue_response()</code>. eRPC will free it when the response is no longer needed for retransmission.</li>
</ul>
</li>
<li>Burying invariants:<ul>
<li>At clients, the request MsgBuffer is buried (nullified, since the request MsgBuffer is app-owned) on receiving the complete response, and before invoking the continuation. So, a null value of <code>sslot-&gt;tx_msgbuf</code> indicates that the sslot is not waiting for a response. Similarly, a non-null value of <code>sslot-&gt;tx_msgbuf</code> indicates that the sslot is waiting for a response. This is used to invoke failure continuations during session resets.</li>
</ul>
</li>
</ul>
<h2>DPDK notes</h2>
<ul>
<li>Ubuntu's DPDK package is incompatible with Mellanox OFED. The main issue is that Mellanox OFED ships with experimental features (<code>ibv_exp_*</code>) that have different names in the upstream <code>libibverbs-dev</code> used by Ubuntu DPDK. For example, headers for multi-packet RQs are in <code>verbs_exp.h</code> in Mellanox OFED, but in <code>mlx5dv.h</code> in <code>ibverbs-providers</code>.</li>
<li>DPDK does not allow loopback. (Strangely, loopback works with Mellanox's Raw Ethernet transport, but not with DPDK, which internally uses Raw. This could because all QPs in the mlx5 PMD use the same device context, whereas eRPC's RawTransport uses separate device contexts.) A machine with multiple ports is needed unit-test with DPDK.</li>
<li>eRPC does not work in Azure as of August 2018: The DPDK driver for ConnectX-3 NICs does not support any flow steering filters. It might be possible to use ConnectX-3 NICs in Ethernet mode with Mellanox's Raw transport, but the current Raw transport implementation assumes <code>mlx5</code>.</li>
</ul>
<h2>RPC failures</h2>
<ul>
<li>On session reset, the client may get continuation-with-failure callbacks. These are identical to non-failure continuations, but the user-owned response MsgBuffer is temporarily resized to 0.</li>
</ul>
<h2>General session management notes</h2>
<ul>
<li>Applications generate session management (SM) packets using eRPC API calls <code>create_session()</code> and <code>destroy_session()</code>. <code>create_session()</code> sends a connect request, and <code>destroy_session()</code> sends a disconnect request.</li>
<li>The Nexus runs an SM thread that listens for SM packets. This thread enqueues received packets into the SM queue of the Rpc specified by the packet's destination application TID.</li>
<li>To handle SM requests, an Rpc must enter its event loop. Although SM packets can be generated outside the event loop, they can only be handled inside an event loop.</li>
<li>On entering the event loop, the Rpc checks its Nexus hook for new SM packets. If there are new packets, it invokes SM handlers.</li>
</ul>
<h2>Session management invariants</h2>
<ul>
<li>XXX: The RPC's session connect/disconnect request/response handlers are guaranteed to see a non-resetted session.</li>
<li>XXX: A server's reset handler always sees a connected session. This is because a server session is immediately destroyed on processing an SM disconnect request.</li>
<li>XXX: A client's reset handler may see a session in the connected or disconnect-in-progress state.</li>
</ul>
<h2>Session management retries</h2>
<ul>
<li>A session management operation is retried by the client in these cases:<ul>
<li>XXX: Add cases here</li>
<li>A session connect request fails because the server does not have the requested RPC ID running, and <code>retry_connect_on_invalid_rpc_id</code> is set.</li>
</ul>
</li>
</ul>
<h2>Compile-time optimization notes:</h2>
<ul>
<li>Optimizations for <code>consensus</code>:<ul>
<li>Set session request window to 1, or implement Rpc flush.</li>
<li>Set transport max inline size to 120 bytes for ConnectX-3.</li>
</ul>
</li>
</ul>
<h2>Immediate TODOs</h2>
<ul>
<li>This list should be empty :)</li>
<li><code>large_msg_test</code> fails when there are only 512 huge pages. This is OK, but the error occurs during memory registration (on InfiniBand). It should occur in <code>alloc_raw</code>.</li>
<li>On slow machines, tests might take too long, so <code>kTestMaxEventLoopMs</code> might be too short a duration. Ideally we would like to run the test as long as we're steadily getting responses. This can be done cleanly in <code>wait_for_rpc_resps_or_timeout</code>.</li>
</ul>
<h2>Short-term TODOs</h2>
<ul>
<li>Session reset and machine failure detection broke when I changed session management to use UDP instead of ENet.</li>
<li><code>pkt\_loss\_stats</code> is more hotly-accessed than its placement in <code>class Rpc</code>.</li>
<li>In <code>rpc_enqueue_request.cc</code>, why don't we always have to set <code>cont_etid</code>?</li>
<li>Make a list of functions allowed in request and continuation handler. For example, re-entering the event loop isn't allowed, and eRPC does not guard against these errors.</li>
<li>Make apps use BasicAppContext and <code>basic_sm_handler</code>.</li>
<li>Use <code>rt_assert</code> in src and apps.</li>
<li>In IBTransport, check if MLX environment vars are set. Do it in constructor.</li>
<li>RFR sending needs to be paced, so we cannot use <code>send_rfr_now</code>.</li>
<li>Do we need separate <code>rx_burst()</code> and <code>post_recvs()</code> functions in Transport?</li>
</ul>
<h2>Long-term TODOs</h2>
<ul>
<li>Fix compilation of <code>mica_test</code>. It gets incomplete type errors for MICA in YouCompleteMe, and <code>pthread_create missing</code> error with DPERF=ON.</li>
<li>Sync modded and original mlx4 drivers, similar to mlx5.</li>
<li>Enable marking an Rpc object as server-only. Such an Rpc object can bypass packet loss detection code in the event loop.</li>
<li>Handle MsgBuffer allocation failures in eRPC.</li>
<li>Create session objects from a hugepage-backed pool to reduce TLB misses.</li>
<li>The first packet size limit could be smaller than MTU to improve RTT measurement accuracy (e.g., it could be around 256 bytes). This will need many changes, mostly to code that uses TTr::kMaxDataPerPkt.<ul>
<li>We must ensure that a small response message packet or a credit return packet is never delayed by TX queueing (even by congestion control&ndash;related TX queueing) or we'll mess up RTT measurement.</li>
<li>Credit return packets will need the packet number field so that the receiver can match RTT.</li>
</ul>
</li>
</ul>
<h2>Longer-term TODOs</h2>
<ul>
<li>Optimize <code>pkthdr_0</code> filling using preconstructed headers.</li>
<li>Need to have a test for session management request timeouts. </li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
